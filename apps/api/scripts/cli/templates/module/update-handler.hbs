import { CommandHandler, ICommandHandler } from '@nestjs/cqrs';
import { Inject, Injectable } from '@nestjs/common';
import { NotFoundException } from '@api/common/exceptions';

import { UpdateCommand } from '@api/common/abstract/application/commands.abstract';
import { Update{{pascalCase name}}Request } from '@repo/shared';
import { {{pascalCase name}} } from '../../domain/entities/{{kebabCase name}}.entity';
import {
    I{{pascalCase name}}Repository,
    {{constantCase name}}_REPOSITORY,
} from '../../domain/repositories/i-{{kebabCase name}}.repository';

export class Update{{pascalCase name}}Command extends UpdateCommand<Update{{pascalCase name}}Request> {}

@CommandHandler(Update{{pascalCase name}}Command)
export class Update{{pascalCase name}}Handler implements ICommandHandler<Update{{pascalCase name}}Command> {
    constructor(
        @Inject({{constantCase name}}_REPOSITORY) private readonly repository: I{{pascalCase name}}Repository,
    ) {}

    async execute(command: Update{{pascalCase name}}Command): Promise<{{pascalCase name}}> {
        const { id, data } = command;

        const {{camelCase name}} = await this.repository.findById(id);
        if (!{{camelCase name}}) {
            throw new NotFoundException('{{pascalCase name}}');
        }

{{#if fields}}
{{#each fields}}
        if (data.{{camelCase this.name}} !== undefined) {
            {{camelCase @root.name}}.update{{pascalCase this.name}}(data.{{camelCase this.name}});
        }
{{/each}}
{{else}}
{{/if}}

        return await this.repository.save({{camelCase name}});
    }
}